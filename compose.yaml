# Restaurant Management API - Multi-container Orchestration
services:
  db:
    image: mysql:8.0
    restart: always # Ensures DB restarts automatically on failure
    environment:
      # These variables are mapped from the .env file
      # To perform migrations/administrative tasks
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}

      # To create app-specific user
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}

    # Bind to the same local host port
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql # Persistent storage for restaurant data
    healthcheck:
      # Use mysqladmin ping to check if the server is accepting connections.
      # CMD is used to run the command inside the container environment.
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]

      # How often to perform the check. 10s is a balance between responsiveness and CPU usage.
      interval: 10s

      # Max time allowed for a single check to complete before it's marked as a failure.
      timeout: 10s

      # Total failed attempts allowed before the container is officially labeled 'unhealthy'.
      # 30 retries @ 10s interval = roughly 5 minutes of total waiting time.
      retries: 30

      # CRITICAL FOR WSL2: The grace period (in seconds) before Docker starts counting failures.
      # MySQL 8.0 on WSL2 takes ~3 mins to initialize its internal system files on first run.
      start_period: 180s

  web:
    build: . # Builds image from local Dockerfile
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app
    ports:  # Bind to the same local host port
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      db: # Django won't start until the database container is ready
        condition: service_healthy  # It will require a service_healthy state before starting

volumes:
  mysql_data:
